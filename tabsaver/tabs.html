<html>
    <script type="text/javascript" charset="utf-8" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="date_format.js"></script>
    <script type="text/javascript" charset="utf-8" src="sessions.js"></script>
    <style type="text/css" media="screen">
        ul.windows {
            /*display: none;*/
        }
        ul.tabs {
            list-style-type: none;
            padding-left: 0px;
        }
        .favicon {
            width: 20px;
            float: left;
        }
        .check {
            float: left;
        }
    </style>
<body>

    <div id="tabs"></div>

    <script type="text/javascript" charset="utf-8">

        function getCheckName(j, k) {
            return ;
        }

        function displaySessions() {

            var div = $("#tabs");
            var html = "<h1>Auto-saved sessions</h1>";

            if (!sessions || sessions.length == 0) {
                html += "<p>none available</p>";
                div.append(html);
                return;
            }

            for (var i=0; i < sessions.length; i++) {
                var session = sessions[i];
                var time = new Date(session.time);
                html += "<h2>" + time.format("M j, Y h:i:s a") + "</h2>";

                html += '<a href="#" class="show_session" id="show_session_' + i + '" session="' + i + '">show contents</a>';
                html += '&nbsp;&nbsp;&nbsp;<input type="button" class="btn_restore_session btn_restore_session_' + i + '" session="' + i + '" value="restore this session" />';
                div.append(html);

            };

        }

        function displaySession(i) {

            var session = sessions[i];
            var anchor = $(".btn_restore_session_" + i);

            var html = '<ul class="windows" id="session_' + i + '">';
            for (var j=0; j < session.windows.length; j++) {
                var win = session.windows[j];

                html += "<li>";
                html += "<h3> Window " + (j+1) + "</h3>";

                // window toolbar
                html += '<div class="window_tools">';
                var win_id = 'window="' + j + '" tabs="' + win.length + '"';
                // html += '<input type="checkbox" class="check_all" ' + win_id + ' id="check_all_' + j + '" />';
                // html += '<label for="check_all_' + j + '">select all</label>';
                html += '<input type="button" class="btn_open_tabs btn_open_tabs_' + j + '" ' + win_id + ' value="open all tabs" />';
                html += '<br/><br/>';
                html += '</div>';

                html += '<ul class="tabs">';

                for (var k=0; k < win.length; k++) {
                    var w = win[k];
                    html += '<li>';

                    var ck = 'c_' + j + '_' + k;
                    html += '<input class="check" id="' + ck + '" type="checkbox" name="' + ck + '" ' + win_id + ' url="' + w.url + '" />&nbsp;';

                    // show favicon
                    html += '<span class="favicon">';
                    if (w.favicon) {
                        html += '<img src="' + w.favicon + '" height="16" width="16" />';
                    } else {
                        html += "&nbsp;";
                    }
                    html += '</span>';

                    html += '<a href="' + w.url + '">' + w.title + '</a></li>';
                };
                html += "</ul>";
                html += "</li>";

            };
            html += "</ul>";
            anchor.after(html);


        }

        // pull tab info from checkboxes based on the given element which contains the session id
        function getTabs(el, checked) {
            var items = [];
            var win = $(el).attr("window");
            var tabs = $(el).attr("tabs");

            for (var i=0; i < tabs; i++) {
                items.push($("#c_" + win + "_" + i)[0]);
            };

            if (!checked) {
                return items;
            }

            // only return checked items:
            // if there is at least 1 checked, return checked
            // else, return all

            var checked = [];
            for (var i=0; i < items.length; i++) {
                if (items[i].checked) {
                    checked.push(items[i]);
                }
            };
            if (checked.length > 0) {
                return checked;
            }
            return items;
        }

        function attachEvents() {
            $(".check_all").live('click', function() {
                // not used anymore
                var checked_status = this.checked;
                $(getTabs(this)).each(function() {
                    this.checked = checked_status;
                });
            });

            $(".btn_open_tabs").live('click', function() {
                // open the selected tabs (or all tabs if none selected)
                var urls = [];
                $(getTabs(this, true)).each(function() {
                    urls.push($(this).attr("url"));
                });
                chrome.windows.create({ url: urls });
            });

            $(".check").live('click', function() {
                // update button label
                var tabs = getTabs(this, true);
                if (tabs.length == $(this).attr("tabs")) {
                    $(".btn_open_tabs_" + $(this).attr("window")).val("open all tabs");
                } else {
                    $(".btn_open_tabs_" + $(this).attr("window")).val("open selected tabs");
                }
            });

            $(".show_session").live('click', function() {
                // show/hide the session
                var id = $(this).attr("session");
                if ($(this).text() == "show contents") {
                    if ($("#session_" + id).length == 0) {
                        displaySession(id);
                    }
                    $("#session_" + id).show();
                    $(this).text("hide contents");
                } else {
                    $("#session_" + id).hide();
                    $(this).text("show contents");
                }
            });

            $(".btn_restore_session").live('click', function() {
                // restore all windows from this session
                var num = $(this).attr("session");
                var sessions = loadSessions();
                var session = sessions[num];
                for (var j=0; j < session.windows.length; j++) {
                    var win = session.windows[j];
                    var urls = [];
                    for (var k=0; k < win.length; k++) {
                        var w = win[k];
                        urls.push(w.url);
                    }
                    chrome.windows.create({ url: urls });
                }
            });
        }

        var sessions = loadSessions();
        displaySessions();
        attachEvents();

    </script>

</body>
</html>
